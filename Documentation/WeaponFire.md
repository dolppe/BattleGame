# WeaponFire

Lyra의 총기의 Fire에 대한 설명

## 개요

Lyra의 총기 발사는 GameplayAbility를 통해서 이루어짐.

- ULyraGameplayAbility_RangedWeapon  
    해당 클래스를 활용하여 GA를 발동시키고, 현재 상황에 맞는 총알을 발사하여 TargetData 정보를 가져옴.

- Flow  
    - GA_Weapon_Fire가 활성화
    - StartRangedWeaponTargeting 함수 실행  
        - 여러 정보들을 고려하여 Trace 진행  
        에임 위치, 캐릭터의 움직임, 총기 확산 정도, 총기 종류 등.
        - TargetData 정보를 Callback 함수에 전달하며 호출  
        => OnRangeWeaponTargetDataReady 호출 (BP상에서 처리)
    - TargetData를 GameplayCueNotify에 전달  
    - GameplayCueNotify에서 BP_Weapon의 Fire 이벤트 실행  
    여기서 내부적으로 Niagara System을 활용하여 시각적 이펙트 처리.
    - GameplayEffect를 통해 데미지 적용


위와 같은 흐름을 가짐.

- 샷건
    - 샷건의 경우에는 TargetData 정보를 추출할 때 LineTrace를 확산 정도를 기반으로 랜덤성을 부여하여 여러 개 진행함.
    - 이를 통해 한번의 Cartridge를 발사 할 때 여러 발의 총알을 발사함.
        - 총알의 궤적을 LineTrace를 통해 처리하기에, 이를 랜덤성을 부여하여 여러번 진행함으로 처리.

## Lyra의 특이점

- LineTrace를 두번 진행함.  
    - 처음 TargetData를 얻기 위해서 진행하는 LineTrace (실제 총알 궤적)
        - 총기 상태, 캐릭터 상태, 에임 방향 등의 상태를 고려함.
        - 위의 정보를 토대로 확산 정도를 계산함.
        - 이 때, 확산 정도에 따라서 랜덤값을 적용하여 총알의 궤적을 설정하고, HitResult 등을 추출하여 TargetData에 저장함.
        - 해당 정보를 이용하여, GameplayEffect를 적용해서 상대 캐릭터에게 데미지를 주는 등의 작업을 수행함.
        - GameplayCue에도 Parameter를 전달하지만, 이는 여러 TargetData가 존재해도 Index 0인 TargetData 하나만 전달함.
    - BP_Weapon의 Fire 이벤트에서 진행하는 LineTrace (이펙트용 보여주기식 가짜 총알 궤적)
        - GameplayCueNotify를 통해 전달 받은 TargetData에 대한 정보는 여러 TargetData 중 하나에 대한 정보만 담고 있음.
        - 샷건의 경우에는 여러 TargetData가 모두 필요함  
        => 이에 대한 이펙트를 만들어야 하기 때문임.
        - 따라서 최초에 전달된 하나의 TargetData에, 자체적으로 랜덤성을 부여하여 다시 LineTrace를 진행함.
        - 실제 총알 궤적과는 다르지만, 이는 그냥 이펙트를 보여주기 위한 용도이기에 랜덤으로 다시 Trace하여 나온 결과를 토대로 이펙트를 생성.


- 요약
    - Lyra에는 실제 총알 궤적과 이펙트용 가짜 총알 궤적 두 가지가 존재함.
    - 실제 총알 궤적  
        - 이는 실제 총의 상태에 따라서 결정되는 확산 정보를 토대로, 랜덤성을 부여하여 Trace를 진행함.
    - 가짜 총알 궤적
        - 이는 실제 총알 궤적 중, 첫 번째 총알 궤적만 가져와서, 이를 토대로 다시 적당한 랜덤성을 부여하여 Trace를 진행함.
    - 샷건의 경우
        - 다른 총기는 한번의 Cartridge 발사에 하나의 총알만 발사됨.  
            - 따라서 실제 총알 궤적과 가짜 총알 궤적이 같음.  
            (실제 총알 궤적이 하나만 나오는데, 이를 가짜 총알 궤적이 사용하기 때문에)
        - 그러나 샷건은 한번의 Cartridge 발사에 여러 개의 총알을 발사함.
            - 따라서 실제 총알 궤적과 가짜 총알 궤적이 다름.  
            (실제 총알 궤적 중 첫 번째 총알 궤적만 제대로 전달되고, 이를 토대로 나머지는 가짜 총알 궤적을 만들기 때문임.)
        - 따라서, 샷건은 실제 데미지를 주는 총알의 궤적과 이펙트로 보여지는 총알의 궤적이 다름.  
            ex) 이펙트상으로는 3발만 맞췄지만, 실제 데미지는 5발이 들어가는 경우가 생김.

- 추측
    - 이렇게 실제 총알 궤적과 가짜 총알 궤적이 다른 이유는 다음과 같음.
        - 실제 총알 궤적이 담긴 TargetData Array를 GameplayCue로 모두 전송하는 것이 아니라, 첫 번째 총알 궤적에 대한 TargetData만 전송하기 때문임.
        - 이를 토대로 이펙트용 가짜 총알 궤적을 만들기 때문임.
    - 이렇게 짠 이유 (추측)
        - GameplayCueNotify의 Parameter가 배열을 받지 못하기 때문임.  
            하나의 궤적만 전송 가능함.
        - 위의 이유로 최적화를 생각하여 이렇게 짠 것 같음.  
            이를 커버하는 가장 쉬운 방법은 모든 TargetData에 대해서 For문을 적용하여 GameplayCue에 전송하는 것임.
            - 모든 TargetData에 For문을 적용하여 GameplayCue Parameter로 변환하고, 이를 각각 GameplayCue에 전송하는 방법.
                - 이는 모든 실제 총알 궤적에 대한 TargetData를 전송할 수 있으나 최적화 문제가 있음.
                - 만약 위와 같은 방법을 사용시 다음과 같은 비효율이 발생함.  
                    - 한번의 GA 실행시, 결과로 나온 TargetData의 개수 만큼의 GameplayCueParameter가 생성됨.  
                    GameplayCue Parameter에는 많은 것이 담겨 있음.  
                    Position, Normal, SurfaceType을 제외한 모든 값이 같지만, 이를 TargetData에 개수만큼 중복해서 생성하게 됨.
                    - 한번의 GA 실행시, 결과로 나온 TargetData 개수 만큼의 GameplayCue가 실행됨.  
                    - BP_Weapon의 Fire Event는 총알 궤적에 대해 Array로 처리 가능함. 그러나 Fire Event가 TargetData의 개수만큼 중복해서 실행됨.  
                    Fire Event의 로직은 여러 개의 총알 궤적이 Array로 전달 됐을 때, 이를 처리할 수 있도록 되어 있음.  
                        - 총을 한번 발사할 때, 총알 궤적은 여러 개일 수 있지만, 총구의 Flash와 같은 효과는 한번만 일어나야함 => 같은 총 발사 이펙트이지만, 분리 해야함.
                        - 한번의 총기 발사에 대한 이펙트이기 때문에 같은 값, 로직이 존재함. => 그러나 이를 Event가 실행될 때마다 중복해서 설정하고, 실행됨.
                    - 요약하면, 한번의 총기 발사에 대한 Event인데, 이를 총알 궤적에 대해서 모두 다시 실행해야 하기 때문에, 중복으로 인한 성능 손실이 분명히 존재함.
                - 따라서, 위의 비효율을 피하고자, 실제 총알 궤적으로 데미지 같은 중요한 것을 적용하고, 이펙트는 최적화를 위해 필요시 가짜 총알 궤적을 새로 만드는 것으로 진행.


- 해결 방법
    - 첫 번째 해결 방법 (일시적으로 채택)  
    현재 문제 상황은 TargetData 배열을 GameplayCue Parameter에 한번에 적용할 수 없는 것임.
    그렇다면, 총기 궤적에 대한 이펙트는 GameplayCue를 거치지 않도록 하면 됨.
        - GA에서 GCN에 파라미터를 넘겨서 FireEvent를 실행시키면, 여러 TargetData에 대한 정보를 넘길 수 없음.
        - 따라서, GA에서 GCN에 이펙트 실행을 요청하는 것이 아닌, GA에서 TargetData 배열을 활용하여 FireEvent를 직접 실행시키면 문제가 없어짐.
    - 두 번째 해결 방법 (추후 진행)  
        - GameplayCueNotify를 상속 받아서 커스텀 GameplayCueNotify를 만드는 것.
        - 해당 커스텀 GCN에는 파라미터로 Array를 처리할 수 있도록 로직을 만들면 됨.

- 해결 방법 선정에 관해  
    추후에 생길 수 있는 확장성을 생각하면, 두 번째 방법을 선택하는 것이 좋아 보임.
    - GameplayCue에 Array로 정보를 넘겨서 이를 토대로 이펙트를 실행해야 하는 경우가 생길 수 있음.
    - 이때, 해당 로직을 만들어두면, 이를 그대로 활용 가능함 (확장성)

    현재 구현해야 할 다른 기능들이 많기에 더 빠르게 구현 가능한 첫 번째 해결 방법을 선택함.
    - 첫 번째 방법은 확장성에 문제가 있음.
    - 또한, GA에서 이펙트를 직접 처리하기 때문에, 해당 GA가 여러 기능, 책임을 가지게 된다는 문제점이 생김.



## Spread              

총기의 상태, 캐릭터의 움직임 등에 따라서 총알의 확산 정도를 수치화하여 적용함.
- 이때, 확산 정도에 랜덤성을 부여하여 실제 총알 궤적을 계산하는 것임.

> 여러 요소들이 존재함. 이는 실제로 적용할 때 문서를 업데이트 할 것.  
현재로는 그냥 임시적인 확산값을 가지게 설정 해둠.



## TargetData

ULyraGameplayAbility_RangedWeapon에서 TargetData를 얻어오는 방법에 대한 설명.

- LineTrace를 위해 필요한 정보  
    - StartTrace (Trace 시작 위치)  
        - 카메라의 Vector를 토대로 AimDir를 구함.
        - Weapon의 Location을 구함
        - 이 두 정보를 종합하여 Trace 시작 위치를 계산함.
        - 단, 원래는 Weapon의 Location을 토대로 진행해야 하는데, 실제 Lyra에서는 그냥 Character인 Actor Location을 토대로 계산함.
    - EndTrace (Trace 끝 위치)  
        StartTrace의 정보와 AimDir, 총기 데이터의 최대 사거리를 적용하여 최종 위치를 계산함.
        - 그러나, 이는 탄퍼짐 정도에 따라서 확산 정도를 고려하여 랜덤성을 부여하여 다시 계산함.
    - SweepRadius (Trace 굵기)  
    이는 총기에 따라서 다르기에, WeaponInstance의 데이터를 가져와서 적용함.


- 확산 정도 적용
    - 조건
        - 현재 상태에 대한 확산 정도에 따라서, 최종적인 EndTrace 값을 바꿔야함.
        - 또한 같은 확산 정도여도 계속 같은 곳을 타격하는 것이 아니라, 랜덤하게 바뀌어야 함.
            - 특히, 샷건의 경우에는 한번의 Cartridge 발사에 대해서는 확산 정도가 같기 때문에, 서로 다른 총알 궤적을 위해 랜덤성을 부여하는 것이 필수적임.
    - 적용
        - StartTrace를 시작으로 퍼져나가는 형태로 원뿔이 그려지게 확산에 적용함.
            - 원뿔의 중심은 StartTrace로 부터, AimDir의 선을 의미함.
            - 원뿔의 밑면 원은 랜덤적으로 총알이 도달할 수 있는 최대치를 의미함. (랜덤적으로 원의 내부에 총알이 박힘)
        - 현재 확산 정도 수치에 따라서 해당 원뿔의 밑면 원의 지름 크기가 달라짐. => 이를 토대로 확산 수치가 높으면, 확률에 따라서 에임에 비해 더 크게 탄이 퍼지도록 함.
        - 월뿔의 표현  
            원뿔은 두 가지 각도를 통해 표현됨.
            - 원의 지름 라인에 대해 퍼지는 Rotation (AngleFromCenter)  
            Yaw에 적용될 각도임.  
            이를 통해 확산 정도에 따른 탄퍼짐의 최대각을 설정함.  
            ex) 만약 최초의 원의 지름이 가로로 일자라고 했을 때, 해당 Rotation만을 이용하면, 이는 탄 퍼짐 정도에 따라서 탄이 왼쪽이나 오른쪽으로만 튀게 됨.
            - 원에서 원의 지름을 돌리는 Rotation (AngleAround)  
            Roll에 적용될 각도이며, 이는 0~360도가 될 수 있음.  
            ex) 만약 이 Rotation만 이용한다면, 지름은 돌아가지만, 결국 탄은 가운데에만 박힐 것임. 
            - 이 두 값을 각각 랜덤으로 값을 뽑아서, 나온 값을 합쳐서 적용함.  
            AngleAround로 원의 지름 중 어느 각도의 원의 지름을 사용할지를 결정함.  
            AngleFromCenter로 원의 중심으로부터 어느 정도의 각도로 탄이 퍼질지를 결정함.

            => 이를 활용하면, 탄퍼짐을 적용하여 원뿔을 그릴 수 있게 되고, 해당 밑면의 원안에 랜덤하게 탄이 도달할 수 있게 EndTrace를 설정할 수 있음.
    - 요약  
    확산 정도는 원뿔로 나타내며 이는 두 가지 Rotation을 활용하여 나타낼 수 있음.  
    해당 Rotation, 거리에 따라서 원뿔의 크기가 달라지며, 이는 확산 정도가 크고, 거리가 멀면 멀수록 탄퍼짐이 더 크게 발생하도록 함.  
    이를 토대로 탄퍼짐을 표현하며, 이는 원뿔의 밑면 원의 내부에 총알이 랜덤하게 박힐 수 있다는 가능성을 의미함.  
    따라서 샷건의 경우에는 같은 탄퍼짐을 가지는 Cartridge에 대해서 여러 랜덤한 총알 궤적을 얻을 수 있는 것임.  
    라이플이나 권총의 경우에는 같은 탄퍼짐을 가질 때 랜덤하게 탄이 퍼질 수 있는 것임.  
    참고로, 우클릭으로 줌을 하면, 확산 정도가 0으로 바뀌기 때문에 원뿔의 반지름이 0이되어서, 이는 선으로 바뀌게 되고, 정확하게 가운데 지점을 사격할 수 있어짐.



